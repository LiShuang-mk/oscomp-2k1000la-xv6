<font face="Ubuntu  Mono">

###### OS大赛 - 内核设计loongarch赛道 - 俺争取不掉队

---------------------------------------------

[ `<= 回到文件系统`](../fs.md)

# VFS简介 


虚拟文件系统（VFS）提供了一个统一的接口来访问不同的文件系统，使得上层用户空间程序无需关心底层使用的是哪种文件系统。VFS通过几个关键的结构体实现这一抽象层，包括SuperBlock、Dentry、Inode和FileSystem。

- **SuperBlock**：超级块是VFS的核心组件之一，它包含了文件系统的元数据信息，如文件系统类型、大小和状态，以及一些文件系统操作的方法。

- **Dentry**：Dentry（目录项）主要用于维护文件名与Inode之间的映射关系，它是内存中文件系统树的一个节点，使得文件系统的遍历成为可能。

- **Inode**：Inode结构体保存了文件的元数据，如文件权限、大小和创建时间等，同时也包含了操作该文件的函数。

- **FileSystem**：这代表了实际的文件系统实现，如EXT4、FAT32等。每种文件系统都有其特定的实现方式，但它们都通过VFS提供的统一接口与上层应用交互。

通过这些组件的协同工作，VFS能够提供一个高效且统一的文件操作接口，简化了文件系统的管理和使用。

## VFS结构概述 
请参考下图。
![](../img/vfs_arch.png)

## DentryCache 目录项缓冲池

为了方便对文件系统中的目录项进行统一的管理，因此我们使用缓冲池，缓冲池中的分配策略采用LRU(最近最少使用)。DentryCache服务于FS，其主要维护了两个DentryList和一个DentryPool，下面介绍其工作原理。 
- **allocDentry**：从目录项池中分配一个空闲的目录项，并把该目录项移入活跃链表(Active_list)；如果池中没有多余的空闲目录项，则从非活跃链表尾部释放一个目录项供分配，并同步递归释放其所有子目录项。
- **touchDentry**: 每当我们访问一个dentry，就需要调整其在LRU链表中的位置，如果其在活跃链表中，则将其移动到活跃链表的首部，否则将其从非活跃链表中移动到活跃链表首部，并递归地移动其所有祖先节点。

#### DentryCache 分配目录项过程
请参考下图。 
![](../img/dentryPoolAllocate.png)




